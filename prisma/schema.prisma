// ==============================================
// 카페매니저 Prisma 스키마
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// 사용자 (User)
// ==============================================

/// 서비스 사용자
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String?
  
  // 라이선스 관련 (3단계에서 활성화)
  planType     PlanType?  @map("plan_type")
  expireAt     DateTime?  @map("expire_at")
  
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  naverAccounts NaverAccount[]   // User 1:N NaverAccount
  naverOauthAccounts NaverOAuthAccount[] // User 1:N NaverOAuthAccount (OAuth 기반 연결)
  naverOauthStates   NaverOAuthState[]   // OAuth state (CSRF 방지/콜백 검증)
  templates     Template[]
  schedules     Schedule[]
  managedPosts  ManagedPost[]
  jobs          Job[]

  @@map("users")
}

/// 사용자 플랜 타입 (3단계에서 활성화)
enum PlanType {
  FREE
  MONTHLY
  YEARLY
}

// ==============================================
// 네이버 계정 (NaverAccount) - User와 네이버 계정 분리
// ==============================================

/// 네이버 계정 정보 (네이버 로그인 자격 증명)
model NaverAccount {
  id                String              @id @default(cuid())
  userId            String              @map("user_id")
  loginId           String              @map("login_id")          // 네이버 로그인 아이디
  passwordEncrypted String              @map("password_encrypted") // 암호화된 비밀번호
  displayName       String?             @map("display_name")       // 표시 이름 (선택)
  
  status            NaverAccountStatus  @default(ACTIVE)
  lastLoginAt       DateTime?           @map("last_login_at")
  lastLoginStatus   String?             @map("last_login_status")  // 마지막 로그인 결과
  lastLoginError    String?             @map("last_login_error")   // 마지막 로그인 에러
  
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions          NaverSession[]

  @@index([userId])
  @@map("naver_accounts")
}

/// 네이버 계정 상태
enum NaverAccountStatus {
  ACTIVE       // 활성 계정
  LOGIN_FAILED // 로그인 실패 (비밀번호 변경 등)
  DISABLED     // 비활성화됨
}

// ==============================================
// 네이버 세션 (NaverSession) - NaverAccount 기반
// ==============================================

/// 네이버 계정 세션 정보 (브라우저 세션/쿠키)
model NaverSession {
  id              String              @id @default(cuid())
  naverAccountId  String              @map("naver_account_id")  // NaverAccount 참조
  profileDir      String              @map("profile_dir")       // Playwright 프로필 디렉토리
  status          NaverSessionStatus  @default(PENDING)
  lastVerifiedAt  DateTime?           @map("last_verified_at")
  errorMessage    String?             @map("error_message")
  naverNickname   String?             @map("naver_nickname")    // 검증된 네이버 닉네임
  
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  naverAccount    NaverAccount        @relation(fields: [naverAccountId], references: [id], onDelete: Cascade)

  @@index([naverAccountId])
  @@map("naver_sessions")
}

// ==============================================
// 네이버 OAuth 계정 (NaverOAuthAccount)
// - 공식 네이버 로그인(OAuth2)로 연결한 계정 정보
// - "ID/PW 저장" 없이도 네이버 프로필/오픈 API 호출에 사용 가능
// ==============================================

model NaverOAuthAccount {
  id                   String   @id @default(cuid())
  userId               String   @map("user_id")

  // 네이버 사용자 식별자 (프로필 API 응답의 response.id)
  naverUserId           String   @map("naver_user_id")

  // 프로필(가능한 범위)
  email                String?
  nickname             String?
  name                 String?
  profileImageUrl      String?  @map("profile_image_url")

  // 토큰 (암호화 저장 권장)
  accessTokenEncrypted String   @map("access_token_encrypted")
  refreshTokenEncrypted String? @map("refresh_token_encrypted")
  tokenType            String?  @map("token_type")          // bearer 등
  tokenExpiresAt       DateTime? @map("token_expires_at")

  connectedAt          DateTime @default(now()) @map("connected_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, naverUserId])
  @@index([userId])
  @@map("naver_oauth_accounts")
}

// ==============================================
// 네이버 OAuth state (NaverOAuthState)
// - CSRF 방지 및 콜백 연동 검증용 (단발성)
// ==============================================

model NaverOAuthState {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  state     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("naver_oauth_states")
}

/// 네이버 세션 상태
enum NaverSessionStatus {
  PENDING  // 세션 초기화 대기 중
  ACTIVE   // 활성 세션
  EXPIRED  // 만료됨
  ERROR    // 오류 발생
}

// ==============================================
// 템플릿 (Template)
// ==============================================

/// 게시글 템플릿
model Template {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  name            String
  
  // 대상 카페/게시판
  cafeId          String    @map("cafe_id")
  boardId         String    @map("board_id")
  cafeName        String?   @map("cafe_name")
  boardName       String?   @map("board_name")
  
  // 템플릿 내용
  subjectTemplate String    @map("subject_template")
  contentTemplate String    @map("content_template") @db.Text
  
  // 템플릿 변수 정의 (JSON 배열)
  // 예: [{"key": "상품명", "label": "상품명", "defaultValue": "", "required": true}]
  variables       Json?     @default("[]")
  
  // 상품 게시판 전용 필드 (선택적)
  price           Int?                              // 가격
  tradeMethod     TradeMethod?  @map("trade_method") // 거래 방법
  tradeLocation   String?       @map("trade_location") // 거래 지역
  
  isActive        Boolean   @default(true) @map("is_active")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  images          TemplateImage[]
  schedules       Schedule[]

  @@index([userId])
  @@index([cafeId, boardId])
  @@map("templates")
}

/// 거래 방법 (상품 게시판용)
enum TradeMethod {
  DIRECT    // 직거래
  DELIVERY  // 택배
  BOTH      // 둘 다 가능
}

// ==============================================
// 템플릿 이미지 (TemplateImage)
// ==============================================

/// 템플릿에 첨부된 이미지
model TemplateImage {
  id            String    @id @default(cuid())
  templateId    String    @map("template_id")
  
  // 파일 정보
  filename      String                    // 저장된 파일명 (UUID 기반)
  originalName  String    @map("original_name")  // 원본 파일명
  mimeType      String    @map("mime_type")      // MIME 타입 (image/jpeg 등)
  size          Int                       // 파일 크기 (bytes)
  path          String                    // 저장 경로
  url           String                    // 접근 URL
  
  // 이미지 메타 정보
  width         Int?                      // 이미지 너비
  height        Int?                      // 이미지 높이
  
  // 순서 관리
  order         Int       @default(0)     // 표시 순서 (0부터 시작)
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  template      Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([templateId, order])
  @@map("template_images")
}

// ==============================================
// 스케줄 (Schedule)
// ==============================================

/// 자동 포스팅 스케줄
model Schedule {
  id              String          @id @default(cuid())
  userId          String          @map("user_id")
  templateId      String          @map("template_id")
  name            String
  
  // 스케줄 설정 (둘 중 하나 사용)
  cronExpr        String?         @map("cron_expr")         // cron 표현식
  intervalMinutes Int?            @map("interval_minutes")  // 분 단위 간격
  
  maxPostsPerDay  Int             @default(10) @map("max_posts_per_day")
  status          ScheduleStatus  @default(PAUSED)
  
  // 실행 정보
  lastRunAt       DateTime?       @map("last_run_at")
  nextRunAt       DateTime?       @map("next_run_at")
  todayPostCount  Int             @default(0) @map("today_post_count")
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  template        Template        @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([templateId])
  @@index([status, nextRunAt])
  @@map("schedules")
}

/// 스케줄 상태
enum ScheduleStatus {
  ACTIVE  // 활성화됨
  PAUSED  // 일시정지됨
  ERROR   // 오류 발생
}

// ==============================================
// 동기화된 게시글 (ManagedPost)
// ==============================================

/// 네이버 카페 "내가 쓴 글" 동기화 정보
model ManagedPost {
  id              String            @id @default(cuid())
  userId          String            @map("user_id")
  
  // 게시글 위치
  cafeId          String            @map("cafe_id")
  boardId         String            @map("board_id")
  articleId       String            @map("article_id")
  articleUrl      String            @map("article_url")
  
  // 게시글 정보
  title           String
  status          ManagedPostStatus @default(ACTIVE)
  createdAtRemote DateTime?         @map("created_at_remote")
  
  // 동기화 정보
  lastSyncedAt    DateTime          @map("last_synced_at")
  deletedAt       DateTime?         @map("deleted_at")
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cafeId, articleId])
  @@index([userId])
  @@index([cafeId, boardId])
  @@index([status])
  @@map("managed_posts")
}

/// 게시글 상태
enum ManagedPostStatus {
  ACTIVE   // 게시 중
  DELETED  // 삭제됨
  UNKNOWN  // 상태 불명
}

// ==============================================
// 작업 (Job)
// ==============================================

/// 백그라운드 작업
model Job {
  id           String    @id @default(cuid())
  type         JobType
  userId       String    @map("user_id")
  
  // 작업 정보
  payload      Json      @default("{}")
  status       JobStatus @default(PENDING)
  errorMessage String?   @map("error_message") @db.Text
  
  // 재시도 정보
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3) @map("max_attempts")
  
  // 타임스탬프
  createdAt    DateTime  @default(now()) @map("created_at")
  startedAt    DateTime? @map("started_at")
  finishedAt   DateTime? @map("finished_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs         JobLog[]

  @@index([userId])
  @@index([type, status])
  @@index([createdAt])
  @@map("jobs")
}

/// 작업 타입
enum JobType {
  INIT_SESSION    // 네이버 세션 초기화
  VERIFY_SESSION  // 세션 검증 (로그인 상태 + 닉네임 확인)
  CREATE_POST     // 게시글 작성
  SYNC_POSTS      // 내가 쓴 글 동기화
  DELETE_POST     // 게시글 삭제
}

/// 작업 상태
enum JobStatus {
  PENDING     // 대기 중
  PROCESSING  // 처리 중
  COMPLETED   // 완료
  FAILED      // 실패
  CANCELLED   // 취소됨
}

// ==============================================
// 작업 로그 (JobLog)
// ==============================================

/// 작업 실행 로그
model JobLog {
  id        String      @id @default(cuid())
  jobId     String      @map("job_id")
  level     JobLogLevel
  message   String      @db.Text
  meta      Json?
  
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  job       Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([createdAt])
  @@map("job_logs")
}

/// 로그 레벨
enum JobLogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

// ==============================================
// 2단계: 게시글 유지 규칙 (PostRule) - 스키마만 정의
// ==============================================

/// 게시글 유지 규칙 (2단계에서 활성화)
model PostRule {
  id        String       @id @default(cuid())
  userId    String       @map("user_id")
  cafeId    String       @map("cafe_id")
  boardId   String?      @map("board_id")  // null이면 카페 전체 적용
  
  type      PostRuleType
  value     Int                            // MAX_COUNT일 경우 유지할 개수
  enabled   Boolean      @default(true)
  
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  @@index([userId])
  @@index([cafeId, boardId])
  @@map("post_rules")
}

/// 규칙 타입
enum PostRuleType {
  MAX_COUNT  // 최대 N개 유지
}




